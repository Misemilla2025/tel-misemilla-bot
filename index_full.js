// === MI SEMILLA BOT ‚Äì Versi√≥n Final (Blindaje Total + Reintento) ===
// Autor: Ale (Total Business)
// Fecha: Octubre 2025
// Descripci√≥n: versi√≥n estable 100% funcional con blindaje, reintento Supabase,
// y actualizaci√≥n sensible/no sensible totalmente operativa.
// Compatible con Node.js v22+ (modo local y Render).

try { require('dotenv').config(); } catch (_) {}

const fs = require('fs');
const path = require('path');
const express = require('express');
const QRCode = require('qrcode');
const qrcodeTerminal = require('qrcode-terminal');
const { createClient } = require('@supabase/supabase-js');
const {
  default: makeWASocket,
  useMultiFileAuthState,
  DisconnectReason,
  fetchLatestBaileysVersion
} = require('@whiskeysockets/baileys');

// === Config Supabase (modo local con llaves incluidas) ===
// Si luego subes a Render, puedes mover estas llaves a variables de entorno.
const SUPABASE_URL = process.env.SUPABASE_URL || 'https://hybozykbfehfjldhaxpp.supabase.co';
const SUPABASE_KEY = process.env.SUPABASE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5Ym96eWtiZmVoZmpsZGhheHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMjU0OTMsImV4cCI6MjA3NDkwMTQ5M30.Bj1Jl3-g0gyp1UwsiK-cwjS8Cm2z7Il4_jZ-tCQhbwM';
const TABLE        = process.env.TABLE || 'registros_miembros';
const BOT_DISPLAY_NAME = process.env.BOT_DISPLAY_NAME || 'Mi Semilla';

const BOT_DISPLAY_NAME = process.env.BOT_DISPLAY_NAME || 'Mi Semilla';

// === Cargar sesi√≥n previa desde Supabase ===
async function loadSessionFromSupabase() {
  try {
    console.log("üü° Verificando sesi√≥n previa en Supabase...");
    const { data, error } = await supabase
      .from("sesion_whatsapp")
      .select("datos")
      .eq("nombre", "mi_sesion")
      .maybeSingle();

    if (error) throw error;
    if (data && data.datos) {
      const fs = require("fs");
      const path = require("path");
      const dir = "./auth_info_full";
      if (!fs.existsSync(dir)) fs.mkdirSync(dir);
      for (const [fname, content] of Object.entries(data.datos)) {
        fs.writeFileSync(path.join(dir, fname), Buffer.from(content, "base64"));
      }
      console.log("‚úÖ Sesi√≥n restaurada desde Supabase");
    } else {
      console.log("‚ÑπÔ∏è No hay sesi√≥n previa en Supabase");
    }
  } catch (err) {
    console.error("‚ö†Ô∏è Error cargando sesi√≥n Supabase:", err.message);
  }
}

// === Directorio de autenticaci√≥n de WhatsApp (Baileys) ===
const AUTH_DIR = process.env.AUTH_DIR || './auth_info_full';
if (!fs.existsSync(AUTH_DIR)) {
  fs.mkdirSync(AUTH_DIR, { recursive: true });
  console.log("üìÇ Carpeta de autenticaci√≥n creada:", AUTH_DIR);
} else {
  console.log("üîê Carpeta de autenticaci√≥n detectada:", AUTH_DIR);
}
const QR_FILE = path.join(AUTH_DIR, 'qr_code.png');

// === Persistencia de sesi√≥n en Supabase ===
async function saveSessionToSupabase() {
  try {
    // Recopilar archivos del AUTH_DIR como mapa nombre->base64
    const files = fs.readdirSync(AUTH_DIR).filter(f => fs.statSync(path.join(AUTH_DIR, f)).isFile());
    const payload = {};
    for (const f of files) {
      const p = path.join(AUTH_DIR, f);
      const buf = fs.readFileSync(p);
      payload[f] = buf.toString('base64');
    }
    const { error } = await supabase
      .from('sesion_whatsapp')
      .upsert({ nombre: 'mi_sesion', datos: payload, updated_at: new Date().toISOString() }, { onConflict: 'nombre' });
    if (error) console.error('Supabase saveSession error:', error);
    else console.log('Sesi√≥n guardada en Supabase (sesion_whatsapp).');
  } catch (e) {
    console.error('saveSessionToSupabase fallo:', e);
  }
}

async function loadSessionFromSupabase() {
  try {
    const { data, error } = await supabase
      .from('sesion_whatsapp')
      .select('datos')
      .eq('nombre', 'mi_sesion')
      .maybeSingle();
    if (error) { console.error('Supabase loadSession error:', error); return; }
    if (!data || !data.datos) { console.log('No se encontr√≥ sesi√≥n previa en Supabase.'); return; }
    // Escribir archivos en AUTH_DIR
    if (!fs.existsSync(AUTH_DIR)) fs.mkdirSync(AUTH_DIR, { recursive: true });
    for (const [fname, b64] of Object.entries(data.datos)) {
      const p = path.join(AUTH_DIR, fname);
      fs.writeFileSync(p, Buffer.from(b64, 'base64'));
    }
    console.log('Sesi√≥n restaurada desde Supabase en', AUTH_DIR);
  } catch (e) {
    console.error('loadSessionFromSupabase fallo:', e);
  }
}


// === Cliente Supabase ===
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// === Archivos locales para gestionar estado simple ===
const PENDIENTE_FILE = path.resolve(process.cwd(), 'pendiente.json');
const SESION_FILE    = path.resolve(process.cwd(), 'sesion.json');
const RESTAURAR_FILE = path.resolve(process.cwd(), 'restaurar.json');

function escribirJSON(f, o) { try { fs.writeFileSync(f, JSON.stringify(o || {}, null, 2)); } catch {} }
function leerJSON(f) { try { if (fs.existsSync(f)) return JSON.parse(fs.readFileSync(f, 'utf8') || '{}'); } catch {}; return {}; }
function borrar(f) { try { if (fs.existsSync(f)) fs.unlinkSync(f); } catch {} }

// === Utilidades de n√∫mero/normalizaci√≥n ===
const soloDigitos = (s = '') => String(s || '').replace(/\D/g, '');
function normalizarColombia(v) {
  let d = soloDigitos(v);
  if (d.startsWith('57') && d.length === 12) return d;
  if (d.startsWith('3') && d.length === 10) return '57' + d;
  if (d.length === 10) return '57' + d;
  if (d.startsWith('057') && d.length === 13) return d.slice(1);
  return d;
}
function numeroDesdeMsg(m, from) {
  try {
    let raw = m?.key?.senderPn || m?.key?.participant || m?.participant || from || '';
    if (raw.includes('@')) raw = raw.split('@')[0];
    if (raw.length > 12 && raw.startsWith('1')) {
      const ctx = m?.message?.extendedTextMessage?.contextInfo;
      const jid = ctx?.participant || ctx?.remoteJid || '';
      if (jid.includes('@')) raw = jid.split('@')[0];
    }
    return normalizarColombia(raw);
  } catch { return ''; }
}

// === Fingerprint de dispositivo (blindaje) ===
function fingerprint(meta) {
  try {
    const jid = meta?.key?.remoteJid || "";
    const user = meta?.pushName || "";
    const seed = `${jid}-${user}`;
    let hash = 0;
    for (let i = 0; i < seed.length; i++) {
      hash = (hash << 5) - hash + seed.charCodeAt(i);
      hash |= 0;
    }
    return `fp_${Math.abs(hash)}`;
  } catch {
    return "fp_desconocido";
  }
}

// === Env√≠o de mensajes ===
async function enviar(sock, to, text) {
  try { await sock.sendMessage(to, { text }); }
  catch (e) { console.log('send err:', e?.message); }
}

// === Reintento autom√°tico para consultas Supabase (anti "fetch failed") ===
async function safeQuery(fn, label = 'query') {
  try {
    const res = await fn();
    return res;
  } catch (e) {
    console.warn(`‚ö†Ô∏è Supabase fallo en ${label}, reintentando...`, e?.message || e);
    await new Promise(r => setTimeout(r, 2000)); // espera 2 s
    return await fn();
  }
}

// === Servidor web simple para ver QR ===
const app = express();
let qrData = null;
app.get('/', (req, res) => {
  res.send("üå± Bot Mi Semilla ‚Äì WhatsApp activo ‚úÖ<br><a href='/qr'>üì± Escanear QR</a>");
});
app.get('/qr', async (req, res) => {
  if (!qrData) return res.send('‚ö†Ô∏è No hay QR disponible a√∫n. Espera unos segundos o reinicia el bot.');
  try {
    const dataUrl = await QRCode.toDataURL(qrData);
    res.send(`<h2>Escanea con WhatsApp</h2><img src="${dataUrl}" /><p>Mi Semilla ‚Ä¢ whatsapp</p>`);
  } catch (err) { res.send('‚ùå Error QR: ' + err.message); }
});
const PORT = process.env.PORT || 3000;
app.listen(PORT, '0.0.0.0', () => console.log('üåç Servidor web activo en puerto', PORT));

// === Bot principal ===
async function iniciarBot() {
  await loadSessionFromSupabase();
  const { state, saveCreds } = await useMultiFileAuthState(AUTH_DIR);
  const { version } = await fetchLatestBaileysVersion();

  const sock = makeWASocket({
    version,
    auth: state,
    printQRInTerminal: false,
    browser: [BOT_DISPLAY_NAME, 'Chrome', '10.0'],
    markOnlineOnConnect: false,
    syncFullHistory: false
  });

  sock.ev.on('connection.update', async ({ qr, connection, lastDisconnect }) => {
    if (qr) {
      qrData = qr;
      try { qrcodeTerminal.generate(qr, { small: true }); } catch {}
      try { await QRCode.toFile(QR_FILE, qr); } catch {}
      console.log('üîó QR listo (tambi√©n en /qr)');
    }
    if (connection === 'open') { console.log('üü¢ Conectado a WhatsApp'); qrData = null; }
    if (connection === 'close') {
      const code = lastDisconnect?.error?.output?.statusCode;
      console.log('‚ö†Ô∏è Conexi√≥n cerrada:', code);
      if (code !== DisconnectReason.loggedOut) { setTimeout(iniciarBot, 3000); }
      else { console.log('üö´ Sesi√≥n cerrada. Borra', AUTH_DIR, 'para relogear.'); }
    }
  });
  
  // === Guardar sesi√≥n tambi√©n en Supabase ===
sock.ev.on('creds.update', async () => {
  try {
    await saveCreds();
    console.log("üü° Intentando guardar sesi√≥n en Supabase...");

    const fs = require("fs");
    const path = require("path");
    const dir = "./auth_info_full";
    const files = fs.readdirSync(dir);
    const dataToSave = {};

    for (const f of files) {
      dataToSave[f] = fs.readFileSync(path.join(dir, f)).toString("base64");
    }

    const { error } = await supabase
      .from("sesion_whatsapp")
      .upsert({
        nombre: "mi_sesion",
        datos: dataToSave,
        updated_at: new Date().toISOString(),
      });

    if (error) throw error;
    console.log("üíæ Sesi√≥n guardada correctamente en Supabase ‚úÖ");
  } catch (err) {
    console.error("‚ö†Ô∏è Error guardando sesi√≥n Supabase:", err);
  }
});

  // ====== Listener de mensajes ======
  sock.ev.on('messages.upsert', async ({ messages }) => {
    for (const m of messages) {
      try {
        // Anti-bucle
        if (m.key?.fromMe) continue;

        const texto = (m.message?.conversation || m.message?.extendedTextMessage?.text || '').trim();
        if (!texto) continue;
        const lower = texto.toLowerCase();
        const from = m.key?.remoteJid || '';
        const numero = numeroDesdeMsg(m, from);

        console.log('\n=== DEBUG WHATSAPP ===');
        console.log('Texto:', texto);
        console.log('JID:', from, '‚Üí N√∫mero normalizado:', numero);

        // ----- Comandos b√°sicos -----
        if (lower.startsWith('/start')) {
          await enviar(sock, from, 'üå± *Bienvenido al bot de Mi Semilla.*\nUsa /ayuda para ver los comandos.');
          continue;
        }

        if (lower.startsWith("/info")) {
          await enviar(
            sock, from,
            "‚ÑπÔ∏è *Mi Semilla* es un programa de apoyo comunitario y humanitario.\n\n" +
            "üìå A trav√©s de este bot puedes consultar, actualizar y validar tu registro.\n" +
            "üåç Nuestro objetivo es mantener tu informaci√≥n al d√≠a y fortalecer la red de ayuda."
          );
          continue;
        }

        if (lower.startsWith('/ayuda')) {
          await enviar(sock, from,
            'ü§ñ *Ayuda bot Mi Semilla*\n\n' +
            '‚Ä¢ /info ‚Üí Breve descripcion de que trata el proyecto\n' +
            '‚Ä¢ /misdatos ‚Üí Consultar tus datos (verificaci√≥n segura)\n' +
            '‚Ä¢ /actualizacion campo valor ‚Üí Actualizar un dato\n' +
            '‚Ä¢ /restaurar ‚Üí Recuperar acceso si cambiaste de n√∫mero\n' +
            '‚Ä¢ /glosario ‚Üí Ver nombres de campos v√°lidos\n'
          );
          continue;
        }

        if (lower.startsWith('/glosario')) {
          await enviar(sock, from,
            'üß© *Glosario de actualizaci√≥n de datos*\n\n' +
            'üìå *1Ô∏è‚É£ DATOS PERSONALES:*\n' +
            'nombre_completo, documento, fecha_nacimiento, edad, genero, escolaridad\n\n' +
            'üìû *2Ô∏è‚É£ DATOS DE CONTACTO:*\n' +
            'email, celular\n\n' +
            'üè† *3Ô∏è‚É£ DATOS DE UBICACI√ìN:*\n' +
            'pais, departamento, ciudad, barrio, direccion\n\n' +
            'üè° *4Ô∏è‚É£ INFORMACI√ìN DEL HOGAR:*\n' +
            'vivienda_propia, zona, estrato, personas_en_hogar, personas_trabajan\n\n' +
            'üë®üë©üëßüë¶ *5Ô∏è‚É£ GRUPO FAMILIAR:*\n' +
            'adultos_mayores, menores\n\n' +
            '‚öôÔ∏è *6Ô∏è‚É£ CONDICIONES Y SERVICIOS:*\n' +
            'servicios, discapacidad, detalle_discapacidad\n\n' +
            'üéØ *7Ô∏è‚É£ INTERESES Y PROYECTOS:*\n' +
            'hobbies, emprendimiento\n\n' +
            'ü§ù *8Ô∏è‚É£ REFERENCIAS PERSONALES:*\n' +
            'ref_nombre, ref_whatsapp, ref_telegram\n\n' +
            'üîí *Recuerda:* solo puedes actualizar tus propios datos asociados a tu n√∫mero de WhatsApp.'
          );
          continue;
        }

        // ====== /misdatos ‚Äì Paso A: iniciar ======
        if (lower.startsWith('/misdatos')) {
          escribirJSON(PENDIENTE_FILE, { estado: 'solicitar_id', who: numero });
          await enviar(sock, from, 'ü™™ *Verificaci√≥n de identidad*\nEnv√≠ame tu *documento* o *email* para buscar tu registro.');
          continue;
        }

        // ====== /misdatos ‚Äì Paso B: identificador ======
        const pend = leerJSON(PENDIENTE_FILE);
        if (pend?.estado === 'solicitar_id' && pend?.who === numero && !lower.startsWith('/')) {
          const idVal = texto.trim();
          const isEmail = /\S+@\S+\.\S+/.test(idVal);
          const isDoc   = /^\d{5,}$/.test(idVal.replace(/\D/g, ''));
          if (!isEmail && !isDoc) { await enviar(sock, from, '‚ùå Debes enviar un *email* v√°lido o un *n√∫mero de documento*.'); continue; }

          let q = supabase.from(TABLE).select('*').limit(1);
          if (isEmail) q = q.eq('email', idVal.toLowerCase());
          else q = q.eq('documento', idVal.replace(/\D/g, ''));

          let found = null, error = null;
          try {
            const res = await safeQuery(() => q.maybeSingle(), 'misdatos.buscar');
            found = res?.data; error = res?.error || null;
          } catch (e) { error = e; }

          if (error) { await enviar(sock, from, '‚ö†Ô∏è Error al consultar datos. Intenta m√°s tarde.'); borrar(PENDIENTE_FILE); continue; }
          if (!found) { await enviar(sock, from, '‚ùå No encontr√© un registro con ese identificador.'); borrar(PENDIENTE_FILE); continue; }

          // === Seguridad de dispositivo (blindaje Fingerprint) ===
          const currentFP = fingerprint(m);
          const savedFP = (found.whatsapp_id || "").toString().trim();
          const sameDevice = savedFP &&
            (savedFP.includes(currentFP) || currentFP.includes(savedFP) || savedFP.split("-")[0] === currentFP.split("-")[0]);

          if (savedFP && !sameDevice) {
            await enviar(sock, from, "üö´ Este dispositivo no est√° autorizado para consultar esta cuenta.\nSolo puedes usar */restaurar* para vincular tu cuenta a este nuevo dispositivo.");
            borrar(PENDIENTE_FILE);
            continue;
          }

          if (!savedFP) {
            try { await safeQuery(() => supabase.from(TABLE).update({ whatsapp_id: currentFP }).eq("id", found.id), 'misdatos.vincular'); }
            catch {}
          }

          escribirJSON(PENDIENTE_FILE, { estado: 'solicitar_cel', id: found.id, who: numero });
          await enviar(sock, from, 'üì± Ahora env√≠a tu *n√∫mero de celular* (57 + d√≠gitos) para confirmar identidad.');
          continue;
        }

        // ====== /misdatos ‚Äì Paso C: validar celular y MOSTRAR TABLA ======
        const pendCel = leerJSON(PENDIENTE_FILE);
        if (pendCel?.estado === 'solicitar_cel' && pendCel?.who === numero && !lower.startsWith('/')) {
          const n = normalizarColombia(texto);
          if (!/^\d{11,12}$/.test(n)) { await enviar(sock, from, '‚ùå N√∫mero inv√°lido. Env√≠a solo d√≠gitos (57 + celular).'); continue; }

          let reg = null, err = null;
          try {
            const r = await safeQuery(() => supabase.from(TABLE).select('*').eq('id', pendCel.id).maybeSingle(), 'misdatos.leer_reg');
            reg = r?.data; err = r?.error || null;
          } catch (e) { err = e; }

          if (err || !reg) { await enviar(sock, from, '‚ö†Ô∏è Error al verificar. Intenta de nuevo.'); borrar(PENDIENTE_FILE); continue; }

          const celBase = normalizarColombia(reg.celular || '');
          const wappNum = normalizarColombia((reg.whatsapp_id || '').split('@')[0]);
          if (n !== celBase && n !== wappNum) { await enviar(sock, from, '‚ùå El n√∫mero no coincide con el registro.'); borrar(PENDIENTE_FILE); continue; }

          // Guardar sesi√≥n verificada
          escribirJSON(SESION_FILE, { user_id: reg.id, who: numero, ts: Date.now() });
          borrar(PENDIENTE_FILE);

          // Construir TABLA bonita
          const d = reg;
          const tabla =
`‚úÖ *Identidad verificada.*
üìã *Estos son tus datos de campo actuales:*

üìå *DATOS PERSONALES*
- üë§ *Nombre:* ${d.nombre_completo?.toUpperCase() || 'Sin registrar'}
- ü™™ *Documento:* ${d.documento || 'Sin registrar'}
- üéÇ *Fecha Nacimiento:* ${d.fecha_nacimiento || 'Sin registrar'}
- üßÆ *Edad:* ${d.edad || 'Sin registrar'}
- üöª *G√©nero:* ${d.genero || 'Sin registrar'}
- üéì *Escolaridad:* ${d.escolaridad || 'Sin registrar'}

üìû *DATOS DE CONTACTO*
- ‚úâÔ∏è *Email:* ${d.email || 'Sin registrar'}
- üì± *Celular:* ${d.celular || 'Sin registrar'}

üè† *DATOS DE UBICACI√ìN*
- üåé *Pa√≠s:* ${d.pais || 'Sin registrar'}
- üó∫Ô∏è *Departamento:* ${d.departamento || 'Sin registrar'}
- üèôÔ∏è *Ciudad:* ${d.ciudad || 'Sin registrar'}
- üèòÔ∏è *Barrio:* ${d.barrio || 'Sin registrar'}
- üè° *Direcci√≥n:* ${d.direccion || 'Sin registrar'}

üè° *INFORMACI√ìN DEL HOGAR*
- üè† *Vivienda Propia:* ${d.vivienda_propia || 'Sin registrar'}
- üåÑ *Zona:* ${d.zona || 'Sin registrar'}
- üß± *Estrato:* ${d.estrato || 'Sin registrar'}
- üë®üë©üëßüë¶ *Personas en Hogar:* ${d.personas_en_hogar || 'Sin registrar'}
- üëî *Personas Trabajan:* ${d.personas_trabajan || 'Sin registrar'}

üë®üë©üëßüë¶ *GRUPO FAMILIAR*
- üßì *Adultos Mayores:* ${d.adultos_mayores || 'Sin registrar'}
- üßí *Menores:* ${d.menores || 'Sin registrar'}

‚öôÔ∏è *CONDICIONES Y SERVICIOS*
- üîå *Servicios:* ${d.servicios || 'Sin registrar'}
- ‚ôø *Discapacidad:* ${d.discapacidad || 'Sin registrar'}
- ü©∫ *Detalle Discapacidad:* ${d.detalle_discapacidad || 'Sin registrar'}

üéØ *INTERESES Y PROYECTOS*
- üé® *Hobbies:* ${d.hobbies || 'Sin registrar'}
- üíº *Emprendimiento:* ${d.emprendimiento || 'Sin registrar'}

ü§ù *REFERENCIAS PERSONALES*
- üôç‚ôÇÔ∏è *Ref Nombre:* ${d.ref_nombre || 'Sin registrar'}
- üìû *Ref WhatsApp:* ${d.ref_whatsapp || 'Sin registrar'}
- üì£ *Ref Telegram:* ${d.ref_telegram || 'Sin registrar'}`;

          const instruccion =
`\n‚úèÔ∏è *Si necesitas cambiar algo, usa el comando:*
/actualizacion campo valor

üìò *Si no recuerdas el nombre exacto del campo, usa:* /glosario`;

          await enviar(sock, from, `${tabla}${instruccion}`);
          continue;
        }

        // ====== /actualizacion (requiere sesi√≥n + blindaje dispositivo) ======
        if (lower.startsWith('/actualizacion')) {
          const ses = leerJSON(SESION_FILE);
          if (!ses?.user_id || ses?.who !== numero) { await enviar(sock, from, 'üîí Primero verifica identidad con */misdatos*.'); continue; }

          // Blindaje de dispositivo para actualizaci√≥n
          let regUser = null;
          try {
            const r = await safeQuery(() => supabase.from(TABLE).select('id, whatsapp_id').eq('id', ses.user_id).maybeSingle(), 'act.leer_user');
            regUser = r?.data || null;
          } catch {}
          const currentFP = fingerprint(m);
          const savedFP = (regUser?.whatsapp_id || "").toString().trim();
          const sameDevice = savedFP &&
            (savedFP.includes(currentFP) || currentFP.includes(savedFP) || savedFP.split("-")[0] === currentFP.split("-")[0]);
          if (savedFP && !sameDevice) {
            await enviar(sock, from, "üö´ Este email pertenece a otra cuenta.");
            continue;
          }

          const parts = lower.split(' ').filter(Boolean);
          if (parts.length < 3) { await enviar(sock, from, '‚ö†Ô∏è Formato: */actualizacion campo valor*\nEj: */actualizacion ciudad Bogot√°*'); continue; }

          const campo = parts[1].trim().toLowerCase();
          const valorOriginal = texto.split(' ').slice(2).join(' ').trim();
          if (!valorOriginal) { await enviar(sock, from, '‚ùå Debes indicar un valor.' ); continue; }

          const camposValidos = [
            'nombre_completo','documento','fecha_nacimiento','edad','genero','escolaridad',
            'email','celular',
            'pais','departamento','ciudad','barrio','direccion',
            'vivienda_propia','zona','estrato','personas_en_hogar','personas_trabajan',
            'adultos_mayores','menores',
            'servicios','discapacidad','detalle_discapacidad',
            'hobbies','emprendimiento','ref_nombre','ref_whatsapp','ref_telegram'
          ];
          if (!camposValidos.includes(campo)) { await enviar(sock, from, '‚ùå Campo inv√°lido. Usa */glosario* para ver la lista de campos.'); continue; }

          // Leer valor actual
          let registroActual = null;
          try {
            const { data, error } = await safeQuery(() => supabase.from(TABLE).select(campo).eq('id', ses.user_id).maybeSingle(), 'act.leer_campo');
            if (error) throw error;
            registroActual = data;
          } catch (e) {
            console.error('‚ö†Ô∏è Error consultando campo:', e?.message || e);
            await enviar(sock, from, '‚ö†Ô∏è No pude verificar tu informaci√≥n actual. Intenta m√°s tarde.');
            continue;
          }

          let nuevo = valorOriginal;
          if (campo !== 'email') nuevo = nuevo.toUpperCase();
          if (campo === 'celular') nuevo = normalizarColombia(nuevo);

          const actual = (registroActual?.[campo] || '').toString().trim();
          if (actual && nuevo.toUpperCase() === actual.toUpperCase()) {
            await enviar(sock, from, `‚ö†Ô∏è El campo *${campo}* fue actualizado correctamente.`);
            continue;
          }

          // Campos sensibles requieren confirmaci√≥n + duplicados
          const sensibles = ['email', 'documento', 'celular'];
          if (sensibles.includes(campo)) {
            let dup = null;
            try {
              let q = supabase.from(TABLE).select('id').neq('id', ses.user_id).limit(1);
              if (campo === 'email') q = q.eq('email', valorOriginal.toLowerCase());
              if (campo === 'documento') q = q.eq('documento', valorOriginal.replace(/\D/g, ''));
              if (campo === 'celular') q = q.eq('celular', normalizarColombia(valorOriginal));
              const rdup = await safeQuery(() => q.maybeSingle(), 'act.duplicado');
              dup = rdup?.data || null;
            } catch (e) {
              console.error('‚ö†Ô∏è Error al validar duplicados:', e?.message || e);
              await enviar(sock, from, '‚ö†Ô∏è Error al validar duplicados. Intenta m√°s tarde.');
              continue;
            }
            if (dup) { await enviar(sock, from, `üö´ No se puede actualizar. El *${campo}* ingresado ya est√° registrado en otro usuario.`); continue; }

            escribirJSON(PENDIENTE_FILE, { estado: 'confirmar_sensible', campo, nuevo, user_id: ses.user_id, who: numero });
            await enviar(sock, from, `‚ö†Ô∏è El campo *${campo}* es sensible. ¬øConfirmas actualizarlo a *${valorOriginal}*?\nResponde: *s√≠* o *no*`);
            continue;
          }

          // Guardar cambios directos en no sensibles
          try {
            const { error: updErr } = await safeQuery(() => supabase.from(TABLE).update({ [campo]: nuevo }).eq('id', ses.user_id), 'act.actualizar_no_sensible');
            if (updErr) throw updErr;
            await enviar(sock, from, `‚úÖ El campo *${campo}* fue actualizado correctamente.`);
          } catch (e) {
            console.error('‚ùå Error al actualizar:', e?.message || e);
            await enviar(sock, from, '‚ùå No se pudo actualizar. Intenta nuevamente.');
          }
          continue;
        }

        // ====== Confirmaci√≥n de sensibles ======
        const pend2 = leerJSON(PENDIENTE_FILE);
        if (pend2?.estado === 'confirmar_sensible' && pend2?.who === numero && !lower.startsWith('/')) {
          const affirm = ['si', 's√≠', 'yes', 'y']; const deny = ['no', 'n'];
          if (affirm.includes(lower)) {
            try {
              const { error } = await safeQuery(() => supabase.from(TABLE).update({ [pend2.campo]: pend2.nuevo }).eq('id', pend2.user_id), 'act.confirmar');
              if (error) {
                if (error.code === '23505' || (error.message && error.message.toLowerCase().includes('duplicate key'))) {
                  await enviar(sock, from, 'üö´ Ese dato ya est√° registrado en otra cuenta.');
                } else {
                  await enviar(sock, from, '‚ö†Ô∏è Error temporal al guardar. Intenta m√°s tarde.');
                }
              } else { await enviar(sock, from, '‚úÖ Actualizado correctamente.'); }
            } catch (_) {
              await enviar(sock, from, '‚ö†Ô∏è Ocurri√≥ un problema guardando el dato. Intenta m√°s tarde.');
            }
            borrar(PENDIENTE_FILE); continue;
          } else if (deny.includes(lower)) {
            await enviar(sock, from, '‚ùé Cambio cancelado.'); borrar(PENDIENTE_FILE); continue;
          } else {
            await enviar(sock, from, 'Responde *s√≠* o *no* para confirmar el cambio sensible.'); continue;
          }
        }

        // ====== /restaurar (permite uso desde otro dispositivo) ======
        if (lower.startsWith('/restaurar')) {
          escribirJSON(RESTAURAR_FILE, { estado: 'pedir_id', who: numero });
          await enviar(sock, from, 'üîß *Restauraci√≥n de cuenta*\nEnv√≠a tu *documento* o *email* para buscar tu registro.');
          continue;
        }
        const rest = leerJSON(RESTAURAR_FILE);
        if (rest?.estado === 'pedir_id' && rest?.who === numero && !lower.startsWith('/')) {
          const v = texto.trim();
          const isEmail = /\S+@\S+\.\S+/.test(v);
          const isDoc   = /^\d{5,}$/.test(v.replace(/\D/g, ''));
          if (!isEmail && !isDoc) { await enviar(sock, from, '‚ùå Env√≠a un email v√°lido o documento.'); continue; }
          let q = supabase.from(TABLE).select('*').limit(1);
          if (isEmail) q = q.eq('email', v.toLowerCase());
          else q = q.eq('documento', v.replace(/\D/g, ''));
          let foundR = null;
          try {
            const rr = await safeQuery(() => q.maybeSingle(), 'rest.buscar');
            foundR = rr?.data || null;
          } catch {}
          if (!foundR) { await enviar(sock, from, '‚ùå No encontr√© registro.'); borrar(RESTAURAR_FILE); continue; }
          escribirJSON(RESTAURAR_FILE, { estado: 'pedir_nuevo_cel', id: foundR.id, who: numero });
          await enviar(sock, from, 'üì± Env√≠a tu *nuevo n√∫mero de celular* (57 + d√≠gitos) para actualizar tu registro.');
          continue;
        }
        if (rest?.estado === 'pedir_nuevo_cel' && rest?.who === numero && !lower.startsWith('/')) {
          const nuevoCel = normalizarColombia(texto);
          if (!/^\d{11,12}$/.test(nuevoCel)) { await enviar(sock, from, '‚ùå N√∫mero inv√°lido.'); continue; }
          try {
            // Al restaurar: actualizamos celular y limpiamos whatsapp_id para que se vincule en el pr√≥ximo /misdatos
            const { error: errU } = await safeQuery(() => supabase.from(TABLE).update({ celular: nuevoCel, whatsapp_id: null }).eq('id', rest.id), 'rest.actualizar');
            if (errU) {
              if (errU.code === '23505' || (errU.message && errU.message.toLowerCase().includes('duplicate key'))) {
                await enviar(sock, from, 'üö´ El n√∫mero ingresado ya pertenece a otra cuenta.\nSi cambiaste de dispositivo, usa el comando */restaurar* desde tu nuevo WhatsApp para recuperar el acceso.');
              } else {
                await enviar(sock, from, '‚ö†Ô∏è Error temporal al guardar. Intenta m√°s tarde.');
              }
            }
            else      { await enviar(sock, from, '‚úÖ Tu n√∫mero fue actualizado. Ahora, desde tu nuevo WhatsApp, usa */misdatos* para vincular la cuenta.'); }
          } catch (_) {
            await enviar(sock, from, '‚ö†Ô∏è No fue posible completar la restauraci√≥n. Intenta m√°s tarde.');
          }
          borrar(RESTAURAR_FILE); continue;
        }

        // ========== RESPUESTAS INTELIGENTES ==========
        const restState = leerJSON(RESTAURAR_FILE);
        if (!lower.startsWith('/') &&
            !['si','s√≠','no','s'].includes(lower) &&
            !(restState?.who === numero)) {

          if (lower.includes('hola') || lower.includes('buenas') || lower.includes('saludos')) {
            await enviar(sock, from,
              "ü§ñ ¬°Hola! üëã\nBienvenido(a) al asistente de *Mi Semilla* üå±\n\n" +
              "¬øQu√© deseas hacer hoy?\n\n" +
              "‚Ä¢ /misdatos ‚Üí Ver tu informaci√≥n\n" +
              "‚Ä¢ /actualizacion ‚Üí Modificar un dato\n" +
              "‚Ä¢ /glosario ‚Üí Ver los campos disponibles\n" +
              "‚Ä¢ /restaurar ‚Üí Recuperar tu cuenta"
            ); continue;
          }

          if (lower.includes('ayuda') || lower.includes('orienta') || lower.includes('c√≥mo empiezo') ||
              lower.includes('que debo hacer') || lower.includes('qu√© debo hacer') ||
              lower.includes('necesito actualizar') || lower.includes('consultar') ||
              lower.includes('informaci√≥n') || lower.includes('informacion') || lower.includes('actualizar')) {
            await enviar(sock, from,
              "üß≠ Puedo ayudarte con estos comandos:\n\n" +
              "‚Ä¢ /misdatos ‚Üí Ver tu informaci√≥n actual registrada.\n" +
              "‚Ä¢ /actualizacion ‚Üí Modificar un dato espec√≠fico.\n" +
              "‚Ä¢ /glosario ‚Üí Ver los nombres de los campos disponibles.\n" +
              "‚Ä¢ /restaurar ‚Üí Recuperar tu cuenta si cambiaste usuario o celular.\n\n" +
              "‚úâÔ∏è Escribe por ejemplo:\n`/actualizacion ciudad Bogot√°` o `/misdatos`"
            ); continue;
          }

          if (lower.includes('gracias') || lower.includes('te agradezco') || lower.includes('muy amable')) {
            await enviar(sock, from, 'üòä ¬°Con gusto! Siempre estoy aqu√≠ para ayudarte üåª'); continue;
          }

          if (lower.includes('adi√≥s') || lower.includes('adios') || lower.includes('chao') || lower.includes('nos vemos') || lower.includes('hasta luego')) {
            await enviar(sock, from, 'üëã ¬°Hasta pronto! Que tengas un excelente d√≠a üåø'); continue;
          }

          if (lower.includes('no entiendo') || lower.includes('no se') || lower.includes('no s√©') ||
              lower.includes('error') || lower.includes('ay√∫dame') || lower.includes('ayudame') || lower.includes('problema')) {
            await enviar(sock, from,
              "‚öôÔ∏è Parece que necesitas un poco de ayuda.\n\n" +
              "Prueba con alguno de estos comandos:\n" +
              "‚Ä¢ /misdatos ‚Üí Consultar tu informaci√≥n.\n" +
              "‚Ä¢ /actualizacion ‚Üí Modificar un dato.\n" +
              "‚Ä¢ /restaurar ‚Üí Si perdiste acceso o cambiaste tu usuario."
            ); continue;
          }

          await enviar(sock, from,
            "ü§î No entend√≠ tu mensaje, pero puedo ayudarte con:\n\n" +
            "‚Ä¢ /misdatos ‚Üí Ver tus datos\n" +
            "‚Ä¢ /actualizacion ‚Üí Modificar informaci√≥n\n" +
            "‚Ä¢ /glosario ‚Üí Ver los campos disponibles\n" +
            "‚Ä¢ /restaurar ‚Üí Recuperar tu cuenta"
          ); continue;
        }

        // Comando desconocido
        if (lower.startsWith('/')) {
          await enviar(sock, from, '‚ùî Comando no reconocido. Usa */ayuda*.');
          continue;
        }

        // Mensaje normal
        await enviar(sock, from, 'ü§ñ Hola üëã Usa */misdatos* para consultar tus datos o */actualizacion* para modificarlos.');
      } catch (err) {
        console.error('‚ö†Ô∏è Error handler:', err);
        try { await enviar(sock, from, '‚ö†Ô∏è Hubo un problema procesando tu mensaje.'); } catch {}
      }
    }
  });
}

iniciarBot().catch((e) => console.error('‚ùå Fallo iniciarBot:', e));
